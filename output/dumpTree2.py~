#! /usr/bin/env python
#
# Read almost every field in the event tree.
#

from __future__ import print_function
import glob, os, re, sys, getopt
import ROOT
from ROOT import TFile
#from ROOT import *
#gSystem.Load("libedepsim_io.so")
#from ROOT import TG4Event
ROOT.gInterpreter.ProcessLine('#include "TG4Event.h"')
import pickle
from math import sqrt
import numpy as np
# Print the fields in a TG4PrimaryParticle object
def printPrimaryParticle(depth, primaryParticle):
    print(depth,"Class: ", primaryParticle.ClassName())
    print(depth,"Track Id:", primaryParticle.GetTrackId())
    print(depth,"Name:", primaryParticle.GetName())
    print(depth,"PDG Code:",primaryParticle.GetPDGCode())
    print(depth,"Momentum:",primaryParticle.GetMomentum().X(),
          primaryParticle.GetMomentum().Y(),
          primaryParticle.GetMomentum().Z(),
          primaryParticle.GetMomentum().E(),
          primaryParticle.GetMomentum().P(),
          primaryParticle.GetMomentum().M())

# Print the fields in an TG4PrimaryVertex object
def printPrimaryVertex(depth, primaryVertex):
    print(depth,"Class: ", primaryVertex.ClassName())
    print(depth,"Position:", primaryVertex.GetPosition().X(),
          primaryVertex.GetPosition().Y(),
          primaryVertex.GetPosition().Z(),
          primaryVertex.GetPosition().T())
    print(depth,"Generator:",primaryVertex.GetGeneratorName())
    print(depth,"Reaction:",primaryVertex.GetReaction())
    print(depth,"Filename:",primaryVertex.GetFilename())
    print(depth,"InteractionNumber:",primaryVertex.GetInteractionNumber())
    depth = depth + ".."
    for infoVertex in primaryVertex.Informational:
        printPrimaryVertex(depth,infoVertex)
    for primaryParticle in primaryVertex.Particles:
        printPrimaryParticle(depth,primaryParticle)

# Print the fields in a TG4TrajectoryPoint object
def printTrajectoryPoint(depth, trajectoryPoint):
    print(depth,"Class: ", trajectoryPoint.ClassName())
    print(depth,"Position:", trajectoryPoint.GetPosition().X(),
          trajectoryPoint.GetPosition().Y(),
          trajectoryPoint.GetPosition().Z(),
          trajectoryPoint.GetPosition().T())
    print(depth,"Momentum:", trajectoryPoint.GetMomentum().X(),
          trajectoryPoint.GetMomentum().Y(),
          trajectoryPoint.GetMomentum().Z(),
          trajectoryPoint.GetMomentum().Mag())
    print(depth,"Process",trajectoryPoint.GetProcess())
    print(depth,"Subprocess",trajectoryPoint.GetSubprocess())

# Print the fields in a TG4Trajectory object
def printTrajectory(depth, trajectory):
    print(depth,"Class: ", trajectory.ClassName())
    depth = depth + ".."
    print(depth,"Track Id/Parent Id:",
          trajectory.GetTrackId(),
          trajectory.GetParentId())
    print(depth,"Name:",trajectory.GetName())
    print(depth,"PDG Code",trajectory.GetPDGCode())
    print(depth,"Initial Momentum:",trajectory.GetInitialMomentum().X(),
          trajectory.GetInitialMomentum().Y(),
          trajectory.GetInitialMomentum().Z(),
          trajectory.GetInitialMomentum().E(),
          trajectory.GetInitialMomentum().P(),
          trajectory.GetInitialMomentum().M())
    for trajectoryPoint in trajectory.Points:
        printTrajectoryPoint(depth,trajectoryPoint)

# Print the fields in a TG4HitSegment object
def printHitSegment(depth, hitSegment):
    print(depth,"Class: ", hitSegment.ClassName())
    print(depth,"Primary Id:", hitSegment.GetPrimaryId())
    print(depth,"Energy Deposit:",hitSegment.GetEnergyDeposit())
    print(depth,"Secondary Deposit:", hitSegment.GetSecondaryDeposit())
    print(depth,"Track Length:",hitSegment.GetTrackLength())
    print(depth,"Start:", hitSegment.GetStart().X(),
          hitSegment.GetStart().Y(),
          hitSegment.GetStart().Z(),
          hitSegment.GetStart().T())
    print(depth,"Stop:", hitSegment.GetStop().X(),
          hitSegment.GetStop().Y(),
          hitSegment.GetStop().Z(),
          hitSegment.GetStop().T())
    print(depth,"Contributor:", [contributor for contributor in hitSegment.Contrib])

# Print the fields in a single element of the SegmentDetectors map.
# The container name is the key, and the hitSegments is the value (a
# vector of TG4HitSegment objects).
def printSegmentContainer(depth, containerName, hitSegments):
    print(depth,"Detector: ", containerName, hitSegments.size())
    depth = depth + ".."
    for hitSegment in hitSegments: printHitSegment(depth, hitSegment)

# Read a file and dump it.
def main(argv=None):
    if argv is None:
        argv = sys.argv

    # The input file is generated in a previous test (100TestTree.sh).
    inputFile=TFile("ten-Mu-plus.root")

    # Get the input tree out of the file.
    inputTree=inputFile.Get("EDepSimEvents")
    print("Class:",inputTree.ClassName())

    # Attach a brach to the events.
    event = TG4Event()
    inputTree.SetBranchAddress("Event",event)

    # Read all of the events.
    entries=inputTree.GetEntriesFast()

    segments = {'eventID': [],
                'trackID': [],
                'pdgId': [],
                'x_start': [],
                'x_end': [],
                'y_start': [],
                'y_end': [],
                'z_start': [],
                'z_end': [],
                'dE': [],
                't': [],
                't_start': [],
                't_end': [],
                'dx': [],
                'x': [], 'y': [], 'z': [], 'dEdx':[], 'n_electrons':[], 'long_diff':[],
                'tran_diff': []}
    for jentry in xrange(entries):
        nb = inputTree.GetEntry(jentry)
        if nb<=0: continue
        print("Class: ", event.ClassName())
        print("Event number:", event.EventId)
        # Dump the primary vertices
        # for primaryVertex in event.Primaries:
        #     printPrimaryVertex("PP", primaryVertex)
        # Dump the trajectories
        trajectories = {'pdgId': [], 'trackId': []}
        print("Number of trajectories ", len(event.Trajectories))
        for trajectory in event.Trajectories:
            trajectories['pdgId'].append(trajectory.GetPDGCode())
            trajectories['trackId'].append(trajectory.GetTrackId())
            # printTrajectory("TT",trajectory)
        # Dump the segment containers
        print("Number of segment containers:", event.SegmentDetectors.size())
        for containerName, hitSegments in event.SegmentDetectors:
            for hitSegment in hitSegments:
                segments['eventID'].append(jentry)
                segments['trackID'].append(trajectories['trackId'][hitSegment.Contrib[0]])
                segments['x_start'].append(hitSegment.GetStart().Y()/10)
                segments['y_start'].append(hitSegment.GetStart().Z()/10)
                segments['z_start'].append(hitSegment.GetStart().X()/10+1.5)
                segments['x_end'].append(hitSegment.GetStop().Y()/10)
                segments['y_end'].append(hitSegment.GetStop().Z()/10)
                segments['z_end'].append(hitSegment.GetStop().X()/10+1.5)
                segments['dE'].append(hitSegment.GetEnergyDeposit())
                segments['t'].append(0)
                segments['t_start'].append(0)
                segments['t_end'].append(0)
                xd = hitSegment.GetStop().Y()/10-hitSegment.GetStart().Y()/10
                yd = hitSegment.GetStop().Z()/10-hitSegment.GetStart().Z()/10
                zd = hitSegment.GetStop().X()/10-hitSegment.GetStart().X()/10
                dx = sqrt(xd**2+yd**2+zd**2)
                segments['dx'].append(dx)
                segments['x'].append((hitSegment.GetStop().Y()+hitSegment.GetStart().Y())/20.)
                segments['y'].append((hitSegment.GetStop().Z()+hitSegment.GetStart().Z())/20.)
                segments['z'].append((hitSegment.GetStop().X()+hitSegment.GetStart().X()+30)/20.)
                segments['dEdx'].append(hitSegment.GetEnergyDeposit()/dx)
                segments['pdgId'].append(trajectories['pdgId'][hitSegment.Contrib[0]])
                segments['n_electrons'].append(0)
                segments['long_diff'].append(0)
                segments['tran_diff'].append(0)

    for i,c in enumerate(segments.keys()):
        print("%s = %i"%(c,i)) 

    segments_array = np.vstack(segments.values())
    with open("dict_100k.p", "wb") as pickle_file:
        pickle.dump(segments, pickle_file)

if __name__ == "__main__":

    sys.exit(main())

